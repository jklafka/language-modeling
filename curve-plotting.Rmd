---
title: "Plotting info curves"
author: "Josef Klafka"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
require(tidyverse)
require(here)
require(tidyboot)
require(feather)

knitr::opts_chunk$set(echo = TRUE)
```

```{r info curve plotting}
bootstraps <- read_csv(here("Data/CHILDES/curve_bootstraps.feather"))

bootstraps %>%
  filter(length == 8) %>%
  ggplot(aes(x = position, y = empirical_stat, color = speaker)) + 
    geom_pointrange(aes(ymin = ci_lower, ymax = ci_upper)) + 
    geom_line() + 
    facet_wrap(~language) + 
    scale_x_continuous(breaks = 1:8) + 
    scale_color_brewer()
```

Below is the process by which we create the bootstrapped mean information curves across ngram positions.

```{r read data and bootstrap}
childes_results <- read_feather(here("Data/CHILDES/trigram_results.feather"))

# nest the surprisals for serial bootstrapping
nest_d <- childes_results %>% 
  group_by(language, speaker, length, position) %>% 
  nest() %>%
  filter(length %in% 3:9) %>%
  ungroup()

# non-parametic bootstrap for surprisals within language, speaker, length and position
bootstraps <- nest_d %>% 
  mutate(surprisal = map(data, ~tidyboot_mean(.x, surprisal, nboot = 100))) %>%
  select(-data) %>%
  unnest()

bootstraps %>% 
  write_csv(here("Data/CHILDES/trigram_bootstraps.feather"))
```

```{r get results, eval=F, include=F}
## pull together all results from target languages and knit into one feather
langs <- c("Chinese", "French", "German", "Spanish", "Japanese", "Eng-NA")
output_name <- "trigram_results" # use this to name the combined file

get_childes_results <- function(lang) {
  read_csv(here(paste0("Data/", lang, "_adult_results.csv"))) %>%
    mutate(speaker = "Adult") %>%
    bind_rows(
      read_csv(here(paste0("Data/", lang, "_child_results.csv"))) %>%
        mutate(speaker = "Child")
    ) %>%
    mutate(language = lang)
}

childes_results <- map_dfr(langs, ~get_childes_results(.))

childes_results %>% 
  write_feather(here(paste0("Data/CHILDES/", output_name, ".feather")))
```