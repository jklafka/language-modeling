---
title: Comparing English Corpora
author: Josef Klafka and Dan Yurovsky
date: "`r Sys.Date()`"
output: 
  html_document:
  toc: false
number_sections: false
theme: lumen
toc_float: false
code_folding: show 
---
  
```{r setup, include = FALSE}
# load packages
library(knitr)
library(here)
library(lme4)
library(broom)
library(janitor)
library(glue)
library(directlabels)
library(data.table)
library(ggthemes)
library(tidyverse)

knitr::opts_chunk$set(echo = TRUE)

opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, 
               error = FALSE, cache = FALSE, tidy = FALSE)

theme_set(theme_classic(base_size = 16))
```

```{r load-packages, include = FALSE}
read_corpus <- function(gram, corpus) {
  
  fread(here(glue("Data/surprisals/{gram}/{corpus}.csv"))) %>%
    as_tibble() %>%
    mutate(order = gram, corpus = corpus)
}

corpora <- expand_grid(gram = c("unigram", "trigram"), 
                                   corpus = c("switchboard", "bnc"))

surprisal_estimates <- map2_dfr(corpora$gram, corpora$corpus, read_corpus)
```

```{r, compare-corpora}
samples <- surprisal_estimates %>%
  filter(length %in% c(3, 7, 11, 15, 19)) %>%
  group_by(order, corpus, length, position) %>%
  summarise(mean = mean(surprisal, na.rm = T), 
            sem = sd(surprisal, na.rm = T)/sqrt(sum(!is.na(surprisal)))) %>%
  ungroup() %>%
  mutate(order = factor(order, levels = c("unigram", "trigram")))

ggplot(samples %>% filter(corpus == "switchboard"),
       aes(x = position, y = mean, color = as.factor(length))) + 
  facet_grid(corpus~order) + 
  geom_line() + 
  geom_pointrange(aes(ymin = mean - sem, ymax = mean + sem)) + 
  scale_color_ptol()
```

```{r}
test <- samples %>% filter(length == 15, corpus == "switchboard", 
                           order == "unigram") 
  
fun <- splinefun(test$position, test$mean)

derivs <- test %>%
  #mutate(deriv = fun(position, deriv = 1)) %>%
  mutate(deriv = lead(mean) - mean) %>%
  mutate(diff = abs(lead(deriv) - deriv)) %>%
  pivot_longer(cols = c(mean, deriv, diff), 
               names_to = "measure", values_to = "value")

ggplot(derivs %>% filter(measure %in% c("diff", "mean")),
                         aes(x = position, y = value, color = measure)) + 
  geom_point() + 
  geom_line() + 
  scale_x_continuous(breaks = 1:15) + 
  geom_hline(aes(yintercept = 0),  linetype = "dashed")




ggplot(test, aes(x = position, y = value, color = measure)) + 
  geom_point(position = position_dodge(.25)) + 
  geom_line()


```

```{r, eval = F, include = F}  

NUM_SECTIONS <- 5

## helpers
# Get the quantiles of the different sentence lengths i.e. the positions at the
# different "fifths" of the sentence
get_quantiles <- function(df, num_sections) {
  df %>%
    pull(position) %>%
    quantile(., probs = seq(0, 1, 1/num_sections)) %>%
    round() %>%
    enframe(name = NULL) %>%
    rename(position = value) %>%
    mutate(quantile = 1:(num_sections + 1))
}


relative_slopes <- function(lang_df, pos_list) {
  
  divides <- pos_list %>%
    group_by(length) %>%
    mutate(start_pos = position, end_pos = lead(position)) %>%
    filter(!is.na(end_pos)) %>%
    group_by(length, quantile) %>%
    nest() %>%
    mutate(position = map(data, ~seq(.x$start_pos, .x$end_pos) %>%
                            enframe(name = NULL, value = "position"))) %>%
    select(-data) %>%
    unnest(cols = position)
  
  quantile_groups <- divides %>%
    left_join(lang_df, by = c("length", "position")) %>%
    group_by(quantile, length) %>%
    mutate(position = scale(position)) %>%
    ungroup() %>%
    # mutate(quantile = factor(quantile), length = scale(length))
    mutate(length = as.numeric(scale(length)), quantile = factor(quantile))
  
  # lm(surprisal ~ length * position : quantile + 0,
  lm1 <-   lm(surprisal ~ position : quantile + log(as.numeric(quantile)+1) * length,
       data = quantile_groups)
  
  %>%
    tidy() %>%
    filter(str_detect(term, "position"),
           str_detect(term, "quantile"), !str_detect(term, "length")) %>%
    clean_names() %>%
    mutate(term = gsub("position:quantile", "", term),
           term = as.numeric(term)) %>%
    rename(quantile = term)
}

lang_df <- trigram %>%
  filter(length >= 6)

pos_list <- lang_df %>%
  group_by(length) %>%
  nest() %>%
  mutate(quantiles = map(data, ~get_quantiles(.x, NUM_SECTIONS))) %>%
  select(-data) %>%
  unnest(cols = c(quantiles))

slopes <- relative_slopes(unigram, pos_list)

predictions <- quantile_groups %>%
  mutate(prediction = predict(lm1,  newdata = .)) %>%
  gather(measure, value, surprisal, prediction)

tmp <- predictions %>%
  group_by(measure, quantile, length, position) %>%
  summarise(value = mean(value))

  
lengths <- tmp %>%
  ungroup() %>%
  distinct(length) %>%
  slice(6, 8, 10, 12, 14, 16)

tmp %>%
  filter(length %in% lengths$length) %>%
  ggplot(aes(x = position, y = value, color = measure,
             group = interaction(measure, length))) +
  facet_wrap(~ quantile) + 
  geom_point() + 
  geom_line()
  
  
  
lang_slopes <- slopes %>%
  pull(estimate) %>%
  tibble() %>%
  t() %>%
  as_tibble() %>%
  mutate(language = lang_name) %>%
  rename(slope1 = V1, slope2 = V2, slope3 = V3, slope4 = V4, slope5 = V5)



switchboard %>%
  filter(length %in% c(5, 8, 12)) %>%
  group_by(order, length, position) %>%
  summarise(surprisal = mean(surprisal)) %>%
  ggplot(aes(x = position, y = surprisal, color = order)) +
  facet_wrap(~ length) +
  geom_point() + 
  geom_line() +
  scale_x_continuous(limits = c(0, 13), breaks = seq(1,13,1)) +
  theme_classic()
